---
title: "R Notebook"
output: html_notebook
---

# 1. Aim: 
> Analyse complete dataset of results for RA2 lowland for publication

# 2. Data cheking

```{r message = FALSE, echo=FALSE, include=FALSE}
library(data.table)
library (dplyr)
library (ggplot2)
library(RColorBrewer)
library(tidyr)
library(knitr)
```

## Load raw data

```{r ReadRaw}

dataDir <- "C:\\GitHubRepos\\CCII_ShinyApp\\data\\"

rawData <- "Data_RA2_spinUp.csv"

df_raw <- read.csv(file = paste0(dataDir,rawData))     

summary(df_raw)
```

## Tidy up

- Subset data used in the paper only
- RCP8.5 only
- High WHC soils only
- End-century only

```{r}

dfTemp1 <- df_raw %>%
  filter(thisScenario != "midCentury") %>%
  filter(thisRCP != "RCP45") %>%
  filter(thisRCP != "NonAdRCP45") %>%
  filter(thisSoil == "highWHC") %>%
  dplyr::select(-X,-X.1, -skip) %>% # get rid of extra cols
  mutate(Adaptation = factor(ifelse(grepl("NonAd",thisRCP), "Not adapted sow", "Adapted sow"))) %>%
  mutate(Adaptation = factor(Adaptation, levels=c("Not adapted sow","Adapted sow"))) %>%
  mutate(thisRCP = ifelse(!grepl("NonAd",thisRCP),as.character(thisRCP),
                          substring(as.character(thisRCP),6) # get rid of the prefix in RCP label
                          )) %>%
  mutate(thisRCP = factor(thisRCP)) %>%
  mutate(thisScenario = factor(thisScenario, levels=c("base", "endCentury"), 
                               labels=c("Baseline", "End-century"))) %>%
  mutate(TotalBiomass=TotalBiomass/1000) # kg/ha to t/ha


# merge elevation data
altFile <- "C:\\apsim_dev\\Projects\\CCII\\GIS_layers\\DEM_vcsn\\Altitude_Kaituna_RA2.txt"

alt_info <- read.table(altFile, header=TRUE)

dfTemp2 <- merge(dfTemp1, alt_info, by = c("thisLat", "thisLong"))

# merge land use class data
luFile <- "C:\\apsim_dev\\Projects\\CCII\\filter\\LandUse_NZ_All.txt"
lu_info <- read.table(luFile, header=TRUE)
lu_info <- as.data.frame(lu_info)
lu_info$luCode <- as.numeric(lu_info$luCode)
lu_info$fileNo <- NULL

lu_info <- lu_info %>%
  mutate(lu_class = ifelse(luCode <3, "Arable", 
                           ifelse(luCode %in% 3:4, "Moderate",
                           "Non-arable"))) %>%
mutate(lu_class = as.factor(lu_class))

summary(lu_info)

df_worked <- merge(dfTemp2, lu_info, by = c("row", "col"))

# Clean temporary data from memory
df_raw<-dfTemp1 <- dfTemp2 <- lu_info <- alt_info <- NULL

summary(df_worked)

```

## Check time-slices of each scenario

- Shows actual period of analysed data 
- Already excludes spin-up period

```{r}
df_worked %>%
  dplyr::select(thisScenario,thisRCP, year) %>%
  group_by(thisScenario,thisRCP) %>%
  summarise_each(funs(min, max))%>%
  mutate(DataPeriod = max-min)
```

## Data for mapping baseline yields

- Short and long-cycle hybrids

```{r}

outFolder <- "\\\\Lindfs12\\home$\\Cfleit\\My Documents\\My papers\\2016_CCII_Assessment\\maps\\"

mapData_01 <- df_worked %>%
  filter(thisRCP=="ERA") %>%
  group_by(thisLat, thisLong, thisCrop, thisCultivar) %>%
  dplyr::select(thisLat, thisLong, thisCrop, thisCultivar, TotalBiomass) %>%
  mutate(TotalBiomass=TotalBiomass) %>%
  summarise_each(funs(mean))

summary(mapData_01)

write.table(mapData_01, paste0(outFolder,"Map_01_BaselineYields.txt"),quote = FALSE, row.names = FALSE)
  
```

## Get average baseline yields

```{r}

mapData_01 %>%
  group_by(thisCrop,thisCultivar) %>%
  dplyr::select(thisCrop,thisCultivar, TotalBiomass) %>%
  summarise_each(funs(min, max, mean))

```

## How much a short cycle maize affected yields?

```{r}

mapData_01 %>%
  group_by(thisCrop,thisCultivar) %>%
  dplyr::select(thisCrop,thisCultivar, TotalBiomass) %>%
  summarise_each(funs(max)) %>%
  tidyr::spread(thisCultivar,TotalBiomass) %>%
  mutate(shortEffect=(short-long)/long*100)

```

# Calculate climate change impacts on yield 

- Average of all 20 years per grid-cell

```{r}

# isolate GCM BASELINE from RCPs
df_rcp_base <-  df_worked %>%
  filter(thisRCP == "RCPpast") %>%
  mutate(thisCultivar = factor(thisCultivar, levels=(c("short", "long")))) %>%
  mutate(TotalBiomass_Base = TotalBiomass) %>%
   group_by(row, col, thisGCM, thisCrop, thisCultivar) %>%
   dplyr::select(row, col, thisGCM, thisCrop, thisCultivar, TotalBiomass_Base) %>% # name it differently
   summarise_each(funs(mean))
#summary(df_rcp_base)

# isolate GCM FUTURE from RCPs (includes extra fields that we'll use later)
df_rcp_fut <-  df_worked %>%
  filter(thisRCP != "ERA", thisRCP != "RCPpast") %>% # only future scenarios
  mutate(thisCultivar = factor(thisCultivar, levels=(c("short", "long")))) %>%
  mutate(TotalBiomass = TotalBiomass) %>%
   group_by(thisLat, thisLong, row, col, thisScenario, thisGCM, 
                thisCrop, thisCultivar, thisRCP, Adaptation, lu_class) %>%
  dplyr::select(thisLat, thisLong, row, col, thisScenario, thisGCM, 
                thisCrop, thisCultivar, thisRCP, Adaptation, lu_class, Altitude_masl,luCode, TotalBiomass) %>%
  summarise_each(funs(mean))
#summary(df_rcp_fut)

# create df with "only" 20-year average RCP data per pixel now
df_rcp_only <- merge(df_rcp_fut,
                  df_rcp_base,
                  by=c("row", "col", "thisGCM", "thisCrop", "thisCultivar"))
#summary(df_rcp_only)


# calculates climate change impact on biomass
df_bio_diff <- df_rcp_only %>%
  ungroup() %>%
  mutate(diff_CC_abs = TotalBiomass - TotalBiomass_Base) %>%
  mutate(diff_CC_rel = diff_CC_abs/TotalBiomass_Base*100)
 # mutate(Adaptation = factor(Adaptation, levels=c("Not adapted sow", "Adapted sow"))) %>%
 # mutate(thisCultivar = factor(thisCultivar, levels=c("long", "short")))

summary(df_bio_diff)

# Clean intermediary df from memory
df_rcp_base <- df_rcp_fut <- df_rcp_only <- NULL
```

# Map of climate change effect on yields

- Absolute values and percentage of baseline
- Averaged also by the 6 GCMs

```{r}

# Absolute only
mapData_02 <- df_bio_diff %>%
#  filter(thisCultivar == "short")  %>%
  dplyr::select(thisLat, thisLong, thisCrop, thisCultivar, Adaptation, diff_CC_abs) %>%
  group_by(thisLat, thisLong, thisCrop, thisCultivar, Adaptation) %>%
  summarise_each(funs(mean))

summary(mapData_02)

write.table(mapData_02, paste0(outFolder,"Map_02_YieldChange_Absolute.txt"),quote = FALSE, row.names = FALSE)

# Percentage only
mapData_03 <- df_bio_diff %>%
  dplyr::select(thisLat, thisLong, thisCrop, thisCultivar, Adaptation, diff_CC_rel) %>%
  group_by(thisLat, thisLong, thisCrop, thisCultivar, Adaptation) %>%
  summarise_each(funs(mean))

summary(mapData_03)

write.table(mapData_03, paste0(outFolder,"Map_03_YieldChange_Percentage.txt"),quote = FALSE, row.names = FALSE)

```

# Graph CC impact on biomass

```{r, fig.height=10, fig.width=10}

dodge <- position_dodge(width = 1)
dodge1 <- position_dodge(width = 0.8)
dodge2 <- position_dodge(width = 0.5)
dodge3 <- position_dodge(width = 0.25)

# graph all
av_y_diff <- df_bio_diff %>%
  dplyr::select(thisLat, thisLong, thisGCM, thisCrop, thisCultivar, Adaptation, Altitude_masl, diff_CC_rel) %>%
  group_by(thisLat, thisLong, thisGCM, thisCrop,  Adaptation, thisCultivar) %>%
  summarise_each(funs(mean)) 


av_y_diff %>%
   mutate(thisCultivar = factor(thisCultivar,levels=c("short", "long"),
                               labels=c("short-cycle maize","long-cycle maize"))) %>%
  ggplot(aes(x=Adaptation,y=diff_CC_rel)) +
  geom_jitter(alpha=0.5, position = dodge2, aes(colour = factor(thisGCM), size=Altitude_masl)) +
  scale_size(range = c(0, 4)) +
  geom_boxplot(alpha=0.2,position = dodge) +
  geom_violin(alpha=0.2,position = dodge) +
  facet_grid(thisCrop~thisCultivar, scales = "free") + 
  geom_hline(aes(yintercept = 0), linetype = 2) +
  ylab(" Climate change impact on crop yields (% baseline)")+
  xlab("Sowing date adaptation")  +
  theme(legend.position="top") +
  theme(legend.title=element_blank()) +
  theme(text = element_text(size=20))
```

# get numbers of CC impact

```{r}
av_y_diff %>%
  ungroup() %>%
  group_by(thisCrop,Adaptation,thisCultivar) %>%
  summarise(min=min(diff_CC_rel),
            max=max(diff_CC_rel),
            median=median(diff_CC_rel)
            )
  
```



## Relate climate change impacts to elevation

-use elevation to show pattern of response

```{r, fig.height=8, fig.width=12}

# graph altitude effect
av_y_diff %>%
  mutate(thisCultivar = factor(thisCultivar,levels=c("short", "long"),
                               labels=c("(short-cycle maize)","(long-cycle maize)"))) %>%
  ggplot(aes(x=Altitude_masl,
             y=diff_CC_rel, 
             shape=Adaptation, 
             linetype=Adaptation)) +
  geom_smooth(alpha=0.4) +
  geom_point(aes(colour=thisGCM),alpha=0.4, size = 3) +
  facet_wrap(thisCrop~thisCultivar, scales = "free", ncol=2) + 
  geom_hline(aes(yintercept = 0), linetype = 2) +
  ylab(" Climate change impact on crop yields (% baseline)")+
  xlab("Elevation (m)")  +
  theme(legend.position="top") +
  theme(legend.title=element_blank()) +
  theme(text = element_text(size=18))


```



## combination of wheat and maize responses

```{r, echo=FALSE, warning=FALSE, fig.height=6, fig.width=12}

l_s <- 5

mx <- max(av_y_diff$diff_CC_rel)*0.7
mn <- min(av_y_diff$diff_CC_rel)*1.3

# get GCM variability too
av_sd_y_diff <- df_bio_diff %>%
  dplyr::select(thisLat, thisLong, thisCrop, 
                thisCultivar, Adaptation, Altitude_masl, diff_CC_rel) %>%
  group_by(thisLat, thisLong, thisCrop, Adaptation, Altitude_masl, thisCultivar) %>%
  summarise_each(funs(mean, sd))

# summary(av_sd_y_diff)

# Analyse trade-off between maize and wheat yields
av_sd_y_diff %>%
    mutate(thisCultivar = factor(thisCultivar,levels=c("short", "long"),
                               labels=c("Short-cycle maize","Long-cycle maize"))) %>%
  unite(temp,mean,sd)%>%
  tidyr::spread(thisCrop, temp) %>%
  separate(maize, c("maize_mean","maize_sd"), sep="_") %>%
  separate(wheat, c("wheat_mean","wheat_sd"), sep="_") %>%
  mutate(maize_mean = as.numeric(maize_mean),
         wheat_mean = as.numeric(wheat_mean),
         maize_sd = as.numeric(maize_sd),
         wheat_sd = as.numeric(wheat_sd)) %>%
  ggplot(aes(x=maize_mean, y=wheat_mean, colour=factor(thisCultivar))) +
  geom_point(aes(size = as.numeric(Altitude_masl), shape=thisCultivar), alpha=1) +
  scale_shape(solid = FALSE) +
  facet_wrap(~Adaptation, scales = "free") + 
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  xlab("Maize silage") + 
  ylab("Wheat cover crop") + 
  geom_errorbarh(aes(xmin=maize_mean-maize_sd, xmax=maize_mean+maize_sd),colour="grey", width=.1, alpha=0.8) +
  geom_errorbar(aes(ymin=wheat_mean-wheat_sd, ymax=wheat_mean+wheat_sd), colour="grey", width=.1, alpha=0.8) +
  labs(size="Elevation (m)", colour="Maize genotype", shape="") +
  guides(shape=FALSE) +
  theme(text=element_text(size=18))

```









## Isolate historical "Total Biomass" data for maize

- Isolates total biomass for ERA data
- ERA is interpolated weather data, so "historical" model runs are most realistic baseline 
- Select only "maize" data



















# --------------------------------------------
# Estimate "GENOTYPE" adaptation benefits
# --------------------------------------------

- Isolates total biomass
- Changes to t/ha
- Averages across all years
- Calculates differences between short and long-cycle genotypes (t/ha and %)


```{r HybridAdapt, echo=FALSE, warning=FALSE, fig.height=8, fig.width=8}

# Difference of selecting long instead of short hybrid
df_cult_choice <- df_worked %>%
  group_by(row, col, thisScenario, thisGCM, thisCultivar, thisRCP, 
           Adaptation, thisCrop, thisSoil, Altitude_masl, lu_class) %>%
  dplyr::select(row, col, thisScenario, thisGCM, thisCultivar, thisRCP, 
           Adaptation, thisCrop, thisSoil, Altitude_masl, lu_class, TotalBiomass) %>%
  mutate(TotalBiomass = TotalBiomass/1000) %>%
  summarise_each(funs(mean)) %>%
  tidyr::spread(thisCultivar, TotalBiomass) %>%
   mutate(diff_cv_abs =  long-short,
          diff_cv_rel =  (long-short)/short*100
          ) %>%
  tidyr::gather("DiffType_cv", "DiffValue_cv", diff_cv_abs:diff_cv_rel) %>%
  mutate(DiffType_cv=factor(DiffType_cv))

summary(df_cult_choice)

```

# Graph cultivar effect

- Effect of changing from short- to long-cycle hybrid
- Relative

```{r, fig.height=8, fig.width=12}

dodge <- position_dodge(width = 1)
dodge2 <- position_dodge(width = 0.5)

# graph simple cultivar effect
df_cult_choice %>%
  filter(DiffType_cv == "diff_cv_rel") %>%
  ungroup() %>%
  mutate(thisRCP=factor(thisRCP, levels=c("ERA","RCPpast","RCP45","RCP85"))) %>%
  mutate(Adaptation=factor(Adaptation, levels=c("Not adapted sow","Adapted sow"))) %>%
  ggplot(aes(x=Adaptation,y=DiffValue_cv)) + # , colour = thisCultivar
  geom_jitter(alpha=0.5, position = dodge2, aes(colour = thisGCM)) + # some bug here
  geom_boxplot(alpha=0.2,position = dodge) +
  geom_violin(alpha=0.2,position = dodge) +
  facet_grid(thisCrop+thisSoil~thisRCP+thisScenario, scales = "free") + 
  geom_hline(yintercept = 0, linetype = 2) +
  xlab("Time-slice") + 
  ylab("Yield change by adapting to long-maturity maize (%)") + 
  theme(legend.position="bottom") +
  theme(legend.title=element_blank()) + theme(axis.text.x = element_text(angle = 90))
```

# Average values of cultivar effect

```{r}
# give averages
df_cult_choice %>% 
  group_by(thisCrop, thisScenario,  thisRCP, thisGCM, thisSoil, DiffType_cv) %>%
  dplyr::select(thisCrop, thisScenario,  thisRCP, thisGCM, thisSoil,DiffType_cv,
                DiffValue_cv) %>%
  summarise_each(funs(median)) %>%
   tidyr::spread(DiffType_cv, DiffValue_cv) %>%
  summary()

```

# How come that wheat yield increases with long-cycle maize?

- Only happen at colder environments

- Because low yield in long-maize at high altitides caused a high N% residue to become a N-mineralisation source which caused the cover crop to yield more after long hybrid

```{r, fig.height=8, fig.width=12, include=FALSE}
# why do we have wheat yiedls increasing with long maize hybrids?
df_cult_choice %>%
  filter(thisCrop == "wheat") %>%
  tidyr::spread(DiffType_cv, DiffValue_cv) %>%
  ggplot(aes(x=Altitude_masl,y=diff_cv_rel)) +
  geom_point(aes(colour=thisGCM)) +
  facet_grid(thisRCP~Adaptation+thisSoil)+
  geom_hline(yintercept =0)

```

## Check invididual cases

```{r}
# Check one case
# df_worked %>%
#   filter(thisRCP == "ERA") %>%
#   filter(Adaptation == "Adapted sow") %>%
#   filter(thisSoil == "highWHC") %>%
#   filter(Altitude_masl == max(Altitude_masl)) %>%
#   filter(year == 1988) %>%
#   dplyr::select(CurrentCrop, thisCultivar,TotalBiomass,GrowthLength,IntRadSum,RUEtop,PTfert,SowSoil_N,nitMinTot,PTmin, PTcropn) %>%
#   mutate(totMin=SowSoil_N+nitMinTot+PTfert)
  
# Insight: Low yield in long maize at high altitides caused a high N residue to become N mineralisation source which 
# cased the cover crop to yield more after long hybrid
```

# Altitude effect

- high WHC soil
- Relative diffs

```{r, fig.height=12, fig.width=12}
# copare hybrid effect with altitude
df_cult_choice %>%
  filter(thisSoil == "highWHC") %>%
  filter(thisRCP=="RCP85") %>%
  filter(DiffType_cv == "diff_cv_rel") %>%
  ggplot(aes(x=Altitude_masl,y=DiffValue_cv, colour=thisGCM)) + # , colour = thisCultivar
  geom_point(aes(colour=thisGCM)) +
  geom_smooth() +
  facet_wrap(Adaptation~thisCrop+thisScenario, scales = "free",ncol=4) + 
  geom_hline(yintercept = 0, linetype = 2) +
  xlab("Elevation (m)") + 
  ylab("Yield change by adapting to \nlong-maturity maize (%)") + 
  theme(legend.position="bottom") +
  theme(legend.title=element_blank()) +
    theme(text = element_text(size=18))
```

## How does "total biomass change in rotation" with cultivar choice?

- calculates a total rotation Biomass biomass (should you do this early?)
- Done at "average" per pixel 

```{r}
# calculate total biomass
totalBioRot <- df_worked %>%
  group_by(row, col, thisScenario, thisGCM, thisCultivar, thisRCP, 
           Adaptation, thisCrop, thisSoil) %>%
  dplyr::select(row, col, thisScenario, thisGCM, thisCultivar, thisRCP, 
           Adaptation, thisCrop, thisSoil,Altitude_masl, TotalBiomass) %>%
  mutate(TotalBiomass = TotalBiomass/1000) %>%
  summarise_each(funs(mean)) %>%
  tidyr::spread(thisCrop, TotalBiomass) %>%
  mutate(TotalBiomass_Rot = maize + wheat) %>%
  dplyr::select(-maize, -wheat)

summary(totalBioRot)

```

# do cultivar effect on total biomass

```{r}

df_cult_choice_Rot <- totalBioRot %>%
  tidyr::spread(thisCultivar, TotalBiomass_Rot) %>%
   mutate(diff_cv_abs =  long-short,
          diff_cv_rel =  (long-short)/short*100
          ) %>%
  tidyr::gather("DiffType_cv", "DiffValue_cv", diff_cv_abs:diff_cv_rel) %>%
  mutate(DiffType_cv=factor(DiffType_cv))

summary(df_cult_choice_Rot)

```

## Graph cultivar efect on total biomass

- Main insights: 

```{r, fig.height=6, fig.width=12}
# copare hybrid effect with altitude
df_cult_choice_Rot %>%
  filter(thisSoil == "highWHC") %>%
  filter(thisRCP=="RCP85") %>%
  filter(DiffType_cv == "diff_cv_rel") %>%
  ggplot(aes(x=Altitude_masl,y=DiffValue_cv, colour=thisGCM)) + # , colour = thisCultivar
  geom_point(aes(colour=thisGCM)) +
  geom_smooth() +
#  geom_line() +
#  geom_jitter(alpha=0.5) +
  facet_grid(Adaptation~thisScenario, scales = "free") + 
#  coord_flip() +
  geom_hline(yintercept = 0, linetype = 2) +
  xlab("Elevation (m)") + 
  ylab("Total rotation yield change by adapting to \nlong-maturity maize (%)") + 
  theme(legend.position="top") +
  theme(legend.title=element_blank()) +
    theme(text = element_text(size=18))
```

# Graph for Spain conference

```{r, fig.height=8, fig.width=12}

# FIXME: there is no "not adapted sowing" for baseline so just repeating same run
nonAdaptSow <- df_cult_choice %>%
    filter(thisSoil == "highWHC" & 
           thisCrop == "maize" & 
           thisGCM != "ERA" &
           thisScenario == "Baseline" &
           Adaptation == "Adapted sow") %>%
  ungroup() %>%
  mutate(Adaptation = "Not adapted sow")

# add extra data: "not adapted sowing" for baseline 
df_stacked <- NULL
x <- df_cult_choice %>% ungroup()
df_stacked <- rbind(x,nonAdaptSow)

# same above without wheat (Spain paper graph)


p1 <- df_stacked %>%
  ungroup() %>%
  mutate(Adaptation = ifelse(Adaptation == "Not adapted sow", "Not adapted sow", "Adapted sow")) %>%
  dplyr::filter(thisSoil == "highWHC" & 
           thisRCP != "RCP45" & # keep only RCP 8.5
           thisCrop == "maize" & 
           thisGCM != "ERA") %>% # keep only RCP 8.5
  mutate(Adaptation = factor(Adaptation, levels = c("Not adapted sow", "Adapted sow"))) %>%
  mutate(thisScenario = factor(thisScenario, levels = c("Baseline", "Mid-century","End-century"))) %>%
  filter(DiffType_cv == "diff_cv_rel") %>%
  ggplot(aes(x=Altitude_masl,y=DiffValue_cv, colour=thisGCM)) + # , colour = thisCultivar
  geom_point(aes(colour=thisGCM)) +
  geom_smooth() +
  facet_grid(Adaptation~thisScenario) +  
  geom_hline(yintercept = 0, linetype = 2) +
  xlab("Elevation (m)") + 
  ylab("Yield change by adapting to long-maturity maize (%)") + 
  theme(legend.position="bottom") +
  theme(legend.title=element_blank()) +
  theme(text = element_text(size=18))

p1

#ggsave(file="Fig_GenotypeEffect.tiff",plot=p1, path = dataDir, dpi = 300)

```

# Compare maize and wheat

- Effect of changing to long-cycle cultivar
- Average of all GCMs
- Filtered by RCP 8.5 (4.5 trade off is always present)
- Insight: tradeoff in yield change 

```{r, fig.height=10}

l_s <- 6 # letter size for text

# compare maize and wheat as a function of hybrid choice
df_cult_choice %>%
  ungroup() %>%
  filter(thisRCP == "RCP85") %>%
  mutate(thisScenario = factor(thisScenario, levels = c("Baseline", "Mid-century","End-century"))) %>%
  filter(DiffType_cv == "diff_cv_rel") %>%
  dplyr::select(-long,-short) %>%
  tidyr::spread(thisCrop,DiffValue_cv) %>%
  group_by(row, col, thisSoil, 
           Adaptation, lu_class, thisScenario, Altitude_masl) %>%
  summarise(maize = mean(maize), wheat = mean(wheat)) %>%
  ggplot(aes(x=maize,y=wheat, colour=thisSoil)) + # , colour = thisCultivar
  scale_shape(solid = FALSE) +
  geom_point(aes(size = Altitude_masl, shape=lu_class), alpha = 0.8) +
  facet_grid(Adaptation~thisScenario, scales = "free") + 
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  ylab("Wheat yield change by \nadapting to long-cycle maize (%)") + 
  xlab("Maize yield change by \nadapting to long-cycle maize (%)") + 
  theme(legend.position="top") +
  theme(legend.title=element_blank()) +
  theme(text = element_text(size=22)) +
  xlim(-60,60) + 
  ylim(-60,60) +
  annotate("text", x = 55, y = 45, label = "+Maize\n+Wheat", colour = "darkgrey", size = l_s) +
  annotate("text", x = 55, y = -45, label = "+Maize\n-Wheat", colour = "darkgrey", size = l_s) +
  annotate("text", x = -55, y = 45, label = "-Maize\n+Wheat", colour = "darkgrey", size = l_s) +
  annotate("text", x = -55, y = -45, label = "-Maize\n-Wheat", colour = "darkgrey", size = l_s)

```
# --------------------------------------------
# Estimate "SOWING DATE" adaptation benefits
# --------------------------------------------

# Isolate baseline TotalBiomass values for all RCPs

- This has to be done because baseline "rcp" comes from Rcp_past
- Base runs are common to all RCPs of a given GCM
- Same values for non-adapted runs must be created
- FIXME: this will be complicated for multiple variables, need another solution
- Average of 30 years

```{r ValueOfAdaptSow, echo=FALSE, warning=FALSE, fig.height=8, fig.width=8}



# How does yield and increase compare (XY IDEA)

  # latLong <- df_worked %>% dplyr::select(thisLat, thisLong) %>% unique()
  # write.csv(latLong, "C:\\latLong.csv")

```

```{r}
# # duplicate base scenario for not adapted runs
# df_rcp_base <-  df_worked %>%
#   filter(thisRCP == "RCPpast") %>%
#   mutate(thisCultivar = factor(thisCultivar, levels=(c("short", "long")))) %>%
#   mutate(TotalBiomass_Base = TotalBiomass/1000) %>%
#    group_by(row, col, thisGCM, thisCrop, thisCultivar, thisSoil) %>%
#    dplyr::select(row, col, thisGCM, thisCrop, thisCultivar, thisSoil, TotalBiomass_Base) %>% # name it differently
#    summarise_each(funs(mean))
  
# summary(df_rcp_base)
```





# Merge base TotalBiomass into main dataframe

- Summarise years (mean)

```{r}
# df_rcp_fut <-  df_worked %>%
#   filter(thisRCP != "ERA", thisRCP != "RCPpast") %>% # only future scenarios
#   mutate(thisCultivar = factor(thisCultivar, levels=(c("short", "long")))) %>%
#   mutate(TotalBiomass = TotalBiomass/1000) %>%
# #  group_by(row, col, thisScenario, thisGCM, thisCrop, thisCultivar, thisSoil, thisRCP, Adaptation) %>%
#    group_by(row, col, thisScenario, thisGCM, 
#                 thisCrop, thisCultivar, thisSoil, thisRCP, Adaptation, lu_class) %>%
#   dplyr::select(row, col, thisScenario, thisGCM, 
#                 thisCrop, thisCultivar, thisSoil, thisRCP, Adaptation, lu_class,Altitude_masl,luCode, TotalBiomass) %>%
#   summarise_each(funs(mean))
# 
# summary(df_rcp_fut)

```

# Only RCP data now

- only biomass

```{r}
# df_rcp_only <- merge(df_rcp_fut,
#                   df_rcp_base,
#                   by=c("row", "col", "thisGCM", "thisCrop", "thisCultivar", "thisSoil"))
# summary(df_rcp_only)

```






## Calculate climate change impact on biomass

- rcp only

```{r}
# df_bio_diff <- df_rcp_only %>%
#   ungroup() %>%
#   mutate(diff_CC_abs = TotalBiomass - TotalBiomass_Base) %>%
#   mutate(diff_CC_rel = diff_CC_abs/TotalBiomass*100) %>%
#   mutate(Adaptation = factor(Adaptation, levels=c("Not adapted sow", "Adapted sow"))) %>%
#   mutate(thisCultivar = factor(thisCultivar, levels=c("long", "short")))
# 
# summary(df_bio_diff)

```

## Graph climate change impacts on biomass

- RCP 8.5 only

```{r, fig.height=10, fig.width=10}

dodge <- position_dodge(width = 1)
dodge1 <- position_dodge(width = 0.8)
dodge2 <- position_dodge(width = 0.5)
dodge3 <- position_dodge(width = 0.25)

# graph all
df_bio_diff %>%
  filter (thisRCP == "RCP85") %>%
  ggplot(aes(x=Adaptation,y=diff_CC_rel)) +
  geom_jitter(alpha=0.5, position = dodge2, aes(colour = factor(thisGCM))) +
  geom_boxplot(alpha=0.2,position = dodge) +
  geom_violin(alpha=0.2,position = dodge) +
  facet_grid(thisCrop+thisCultivar~thisScenario+thisSoil, scales = "free") + 
  geom_hline(aes(yintercept = 0), linetype = 2) +
  ylab(" Climate change impact on crop yields (% baseline)")+
  xlab("Sowing date adaptation")  +
  theme(legend.position="top") +
  theme(legend.title=element_blank())
```

# Graph used in NIWA's report 2016 for Anne Gaelle

- Maize only
- RCP 8.5 only

```{r, fig.height=10, fig.width=12}
# graph for report (maize and high WHC)
df_bio_diff %>%
  filter (thisRCP == "RCP85") %>%
  filter (thisCrop == "maize") %>%
 # filter(thisSoil == "highWHC") %>%
  filter (thisGCM != "ERA") %>%
#  mutate(DiffValue = DiffValue/base*100) %>%
  ggplot(aes(x=thisScenario,y=diff_CC_rel)) +
  geom_jitter(alpha=0.5, position = dodge2, aes(colour = factor(thisGCM))) +
  geom_boxplot(alpha=0.2,position = dodge) +
  geom_violin(alpha=0.2,position = dodge) +
 # facet_grid(thisCrop~DiffTime, scales = "free") +
  facet_grid(thisCultivar~Adaptation) + 
 # coord_flip() +
  geom_hline(aes(yintercept = 0), linetype = 2) +
 # theme(legend.position="none") +
  ylab(" Climate change impact on crop yields (% baseline)")+
  xlab("Sowing date adaptation")  +
  theme(legend.position="top") +
  theme(legend.title=element_blank()) +
    theme(text = element_text(size=20))

```

## Paparoa presentation graph

- RCP 8.5 only
- high WCH only
- maize only
- End-entury only

```{r, fig.height=5, fig.width=10}
# graph for paparoa present (maize and high WHC) - 
df_bio_diff %>%
 filter (thisRCP == "RCP85") %>%
 filter(thisSoil == "highWHC" &
          thisCrop == "maize" &
          thisGCM != "ERA" &
          thisScenario == "End-century") %>%
  ggplot(aes(x=thisCultivar  ,y=diff_CC_rel)) +
  geom_jitter(alpha=0.5, position = dodge2, aes(colour = factor(thisGCM))) +
  geom_boxplot(alpha=0.2,position = dodge) +
  geom_violin(alpha=0.2,position = dodge) +
  facet_grid(.~Adaptation, scales = "free") + 
  coord_flip() +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  ylab(" Climate change impact on crop yields (% baseline)")+
  xlab("Maize hybrid")  +
  theme(legend.position="bottom") +
  theme(legend.title=element_blank()) + 
  theme(text=element_text(size=18)) +
    theme(text = element_text(size=20))
```

### Show averages of climate change impact and effectiveness of adapting sowing date

- Catchment average
- campare yield change in maize between adapted and non-adapted
- Effectiveness is % unit change in "yield change due to CC"
- Insight: sowing early was always good for both crops at a "cathment" scale (net result all pixels)

```{r, results='markup'}
# get averages
df_bio_diff %>%
  mutate(Adaptation = ifelse(Adaptation == "Adapted sow", "Adap","NonAd")) %>% 
  filter(thisSoil == "highWHC" & thisGCM != "ERA") %>%
  group_by(thisCrop, thisRCP, thisScenario, thisCultivar,Adaptation) %>%
  dplyr::select(thisCrop, thisRCP, thisScenario, thisCultivar,Adaptation, diff_CC_rel) %>%
  summarise_each(funs(mean)) %>%
  tidyr::spread(Adaptation, diff_CC_rel) %>%
  mutate(AdapEffect = (Adap-NonAd)) %>%
  kable(digits=1) 
```

# Effect of altitude

-RCP8.5
-highWHC
- End-century only

```{r, fig.height=8, fig.width=12}

# FIXME: duplicated points!

# graph altitude effect
df_bio_diff %>%
  mutate(thisCultivar = factor(thisCultivar,levels=c("short", "long"),
                               labels=c("(with short-maize)","(with long-maize)"))) %>%
  filter(thisRCP == "RCP85") %>%
  filter(thisSoil == "lowWHC" & 
        thisScenario == "End-century", 
        thisGCM != "ERA") %>%
  ggplot(aes(x=Altitude_masl,
             y=diff_CC_rel, 
             shape=Adaptation, 
             linetype=Adaptation)) +
  geom_smooth(alpha=0.4) +
  geom_point(aes(colour=thisGCM),alpha=0.4, size = 3) +
  facet_wrap(thisCrop~thisCultivar, scales = "free", ncol=2) + 
  geom_hline(aes(yintercept = 0), linetype = 2) +
  ylab(" Climate change impact on crop yields (% baseline)")+
  xlab("Elevation (m)")  +
  theme(legend.position="top") +
  theme(legend.title=element_blank()) +
  theme(text = element_text(size=18))
```

# Isolate ERA total biomass

- biomass in t/ha

```{r}
# create a df with ERA data
# FIXME: Check if there's use or duplication

df_era <-  df_worked %>%
  filter(thisRCP == "ERA") %>% # only future scenarios
  mutate(thisCultivar = factor(thisCultivar, levels=(c("short", "long")))) %>%
  mutate(TotalBiomass_ERA = TotalBiomass/1000) %>%
  dplyr::select(-TotalBiomass) %>%
  group_by(row, col,thisCrop, thisCultivar, thisSoil) %>%
  dplyr::select(row, col,thisCrop, thisCultivar, thisSoil, TotalBiomass_ERA) %>%
  summarise_each(funs(mean))

summary(df_era)

```

## Climate change per land use (pre-Paparoa presentation)

- RCP 8.5
- High WHC
- Maize

```{r, fig.height=7, fig.width=10}
# graph land use analysus
df_bio_diff %>%
  filter (thisRCP == "RCP85") %>%
  filter(thisSoil == "highWHC"  & thisCultivar == "long" & thisGCM != "ERA") %>%
  ggplot(aes(x=factor(lu_class),y=diff_CC_rel)) +
  geom_jitter(alpha=0.5, position = dodge2, aes(colour = thisGCM)) + # , shape=factor(lu_class)
  geom_boxplot(alpha=0.2,position = dodge) +
  geom_violin(alpha=0.2,position = dodge) +
  facet_wrap(Adaptation~thisCrop+thisScenario, ncol=4) + 
  geom_hline(aes(yintercept = 0), linetype = 2) +
  ylab("Climate change impact \non crop yields (% baseline)")+
  xlab("Land use suitability class")  +
  theme(legend.position="top") +
  theme(legend.title=element_blank()) +
  theme(text = element_text(size=14))+
  ylim(-100,100)

```

## Paparoa graph

- RCP 8.5
- high WHC
- maize
- Adapted

Message: Most of the improvement in on non-arable lands

```{r}
# graph land use analysus (paparoa)
df_bio_diff %>%
   filter (thisRCP == "RCP85") %>%
  filter(thisSoil == "highWHC" & 
           thisCrop == "maize" & 
          thisCultivar == "long" & 
           Adaptation == "Adapted sow" &
           thisGCM != "ERA") %>%
  ggplot(aes(x=factor(lu_class),y=diff_CC_rel)) +
  geom_jitter(alpha=0.5, position = dodge2, aes(colour = thisGCM)) + # , shape=factor(lu_class)
  geom_boxplot(alpha=0.2,position = dodge) +
  geom_violin(alpha=0.2,position = dodge) +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  ylab(" Climate change impact on crop yields (% baseline)")+
  xlab("Land use suitability class")  +
  theme(legend.position="bottom") +
  theme(legend.title=element_blank()) +
  coord_flip()  +
  ylim(-50,50)+
  theme(text=element_text(size=18))
```

# Check yields

```{r}
# check yields 
 df_bio_diff %>%
  group_by(thisCrop, thisCultivar, thisSoil, lu_class) %>%
     filter(thisSoil == "highWHC" & 
           thisCrop == "maize" & 
             thisCultivar == "long" &
           Adaptation == "Adapted sow" &
           thisGCM != "ERA") %>%
  summarise(av = mean(TotalBiomass_Base), low = min(TotalBiomass_Base), high = max(TotalBiomass_Base))
```

# Land use availability

- Number of pixels and hectars in each land use class 
- Percentatge of total area

```{r}
# how much of each lu class is available
df_bio_diff %>%
  filter(
    thisRCP == "RCP85" &
    thisGCM == "BCC-CSM1" &
    thisCrop == "maize" &
    thisCultivar == "long" &
    thisSoil == "highWHC" &
    thisScenario == "Mid-century" &
    Adaptation == "Adapted sow") %>%
  dplyr::select(lu_class) %>%
  group_by(lu_class) %>%
  summarise(obsN = n()*2500) %>% # pixels x 2.500 ha/pixel (5 x 5 km grid)
  mutate(lu_class = factor(lu_class, levels = c("Arable","Moderate","Non-arable"), 
         labels = c("Arable","Moderate","NonArable"))) %>%
  tidyr::spread(lu_class, obsN) %>%
  mutate(Total=sum(Arable,Moderate,NonArable)) %>%
  mutate(Arable_P = round(Arable/Total*100, 2), 
         Moderate_P = round(Moderate/Total*100, 2), 
         NonArable_P = round(NonArable/Total*100, 2))
  
```

## Analyse trade-offs with wheat cover crop

- RCP 8.5
- high WHC
- Average of all GCMs

```{r TradeOffCoverCrop, echo=FALSE, warning=FALSE, fig.height=6, fig.width=12}

l_s <- 5

# Analyse trade-off between maize and wheat yields
df_bio_diff %>%
  filter (thisRCP == "RCP85") %>%
  filter(thisSoil == "highWHC") %>% # FIXME: check also low WHC
  group_by(row, col, thisCrop, thisCultivar, thisSoil, 
           Adaptation, lu_class, thisScenario, Altitude_masl) %>%
  summarise(DiffValue = mean(diff_CC_rel)) %>%
  tidyr::spread(thisCrop, DiffValue) %>%
  ggplot(aes(x=maize, y=wheat, colour=factor(thisCultivar), shape=factor(lu_class))) +
  geom_point(aes(size = as.numeric(Altitude_masl)), alpha=0.8) +
  scale_shape(solid = FALSE) +
  facet_grid(Adaptation~thisScenario, scales = "free") + 
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  xlab("Maize silage yield change (% baseline)") + 
  ylab("Wheat cover crop yield change (% baseline)") + 
 # theme(legend.position="top") +
  labs(size="Elevation (m)", colour="Maize genotype", shape = "Land use class") +
  xlim(-60,60) + 
  ylim(-60,60) +
  annotate("text", x = 55, y = 50, label = "+Maize\n+Wheat", colour = "darkgrey", size = l_s) +
  annotate("text", x = 55, y = -50, label = "+Maize\n-Wheat", colour = "darkgrey", size = l_s) +
  annotate("text", x = -55, y = 50, label = "-Maize\n+Wheat", colour = "darkgrey", size = l_s) +
  annotate("text", x = -55, y = -50, label = "-Maize\n-Wheat", colour = "darkgrey", size = l_s)  +
  theme(text=element_text(size=18))

```

```{r SaveDataForAdam}

# dfTemp <- df_worked %>%
#   mutate(thisCultivar = factor(thisCultivar, levels=(c("short", "long")))) %>%
#   mutate(TotalBiomass=TotalBiomass/1000) %>%
#   mutate(Adaptation = ifelse(thisRCP == "NonAdRCP85", "NotAdapted", "Adapted")) %>%
#   group_by(row, col, thisScenario, thisGCM, thisCrop, thisCultivar, thisSoil, Altitude_masl,lu_class, Adaptation) %>%
#   dplyr::select(TotalBiomass, PTfert) %>%
#   summarise_each(funs(mean))
# 
# head(dfTemp)
# 
# # save data for adam
# adamDF <- dfTemp %>%
#   filter(thisCrop == "maize")
# 
# summary(adamDF)
# 
# write.csv(adamDF, paste0(adaptDir,"SummaryData_RA2_fert.csv"))
# 
# # Idea: perc change vs base yield 

```

# --------------------------------------------
# Total biomass "differences" rotation
# ---------------------------------------------

- Sum "absolute" differences for wheat and maize
- Net climate change effect on sum of maize and wheat biomass

```{r}

df_bio_diff_tot <- df_bio_diff %>%
  dplyr::select(row:luCode,thisCrop,diff_CC_abs) %>%
  tidyr::spread(thisCrop,diff_CC_abs)%>%
  mutate(totBioDiff = maize + wheat) %>%
  dplyr::select(-wheat, -maize)

summary(df_bio_diff_tot)

```
## Plot total biomass differences due to climate change

- RCP 8.5
- End-century
- Much more overlap with low warming (4.5 Mid)
- Fixme: show 95% CI with uncertanty for all GCMs instead of all datapoints

```{r, fig.height=6, fig.width=12}
df_bio_diff_tot %>%
  filter(thisRCP == "RCP85") %>%
  filter(thisScenario == "End-century") %>%
  mutate(thisCultivar = factor(thisCultivar, levels=c("short", "long"), 
                                labels=c("short-maize", "long-maize"))) %>%
  ggplot(aes(x=Altitude_masl,y=totBioDiff, colour=thisGCM, shape=Adaptation)) +
  geom_smooth(alpha=0.2, aes(linetype=Adaptation)) +
  geom_point() +
  scale_shape(solid = FALSE) +
  facet_grid(thisCultivar~thisSoil) +
  geom_hline(yintercept = 0, linetype = 2) +
  ylab("Total crop sequence yield change \ndue to climate change (t/ha)") +
  xlab("Altitude (m)") +
  theme(text=element_text(size=18))+
  theme(legend.title=element_blank())
```

# graph to ZALF presentation

- RCP 8.5
- End-century
- highWHC
- Long-cycle

```{r, fig.height=5, fig.width=12}
# df_bio_diff_tot %>%
#   filter(thisRCP == "RCP85" & 
#            thisScenario =="End-century" & 
#            thisSoil == "highWHC" & 
#            thisCultivar == "long") %>%
#   ggplot(aes(x=Altitude_masl,y=totBioDiff, colour=(thisGCM))) +
#   geom_smooth(aes(linetype=Adaptation), alpha=0.2) +
#   geom_point(aes(shape=Adaptation), size=2)+
#   scale_shape(solid = FALSE) +
#   geom_hline(yintercept = 0, linetype = 2) +
#   ylab("Total yield change (t/ha)") +
#   xlab("Altitude (m)") +
#   theme(text=element_text(size=18))+
#   theme(legend.title=element_blank())
```

#----------------------------------------------
# Effectiviness of adaptation (new metrics)
#----------------------------------------------

## How much adapting sowing dates affect total rotation biomass?

- Percentage effect is NOT a good metrics

## create a metric for efficiency
```{r}

e_func_a <- function(bas,fut) {
  x <- fut-bas
  return(x)
}

e_func_a(5,20)


e_func_p <- function(bas,fut) {
  x <- round((fut-bas)/bas * 100,2)
  return(x)
}

e_func_p(5,20)

```



```{r}

adapt_sow_eff <- df_bio_diff_tot %>%
  mutate(Adaptation = factor(ifelse(Adaptation == "Adapted sow", "Adapt", "NotAdapt"))) %>%
  spread(Adaptation, totBioDiff) %>%
 # mutate(adaptEffect_a = Adapt-NotAdapt)
  mutate(adaptEffect_a = e_func_a(NotAdapt,Adapt))

summary(adapt_sow_eff)

```

```{r, fig.height=8, fig.width=12}

adapt_sow_eff %>%
# arrange(thisGCM, desc(thisGCM)) %>% # vary across panels
  ggplot(aes(x=thisGCM, y=adaptEffect_a)) +
  geom_boxplot(alpha=0.2, aes(colour=thisGCM)) +
  geom_jitter(width=0.2, alpha=0.2, aes(colour=thisGCM)) +
  geom_violin(alpha=0.2,aes(colour=thisGCM) ) +
  facet_grid(thisCultivar~thisSoil+thisScenario, scales='free') + 
  theme(axis.text.x = element_text(angle = 90)) +
  ylab("Crop system yield change by adapting sowing dates (t/ha)")
  
```

# Test proxys to generalise adapt effectiveness

- Weather

```{r}
# read temperatures per gridcell and gcm
weather <- read.csv("C:\\apsim_dev\\Projects\\CCII\\RA2_CaseStudy\\metFiles\\All_Met_Data.csv", header=TRUE)
summary(weather)
```

## isolate ERA temperature

```{r}
temperature <- weather %>%
  mutate(gcmStp = ifelse(gcmStp=="BCC-CSM1.1","BCC-CSM1",as.character(gcmStp))) %>% # correct name issue
  filter(gcmStp != "ERA") %>%
  dplyr::select(gcmStp:mint) %>% 
  mutate(thisGCM=factor(gcmStp)) %>%
  mutate(avt = (maxt+mint)/2) %>%
  filter(year<2010) %>%
  filter(timeSlice =="a_base") %>%
dplyr::select(-maxt,-mint, -timeSlice, -gcmStp) %>%
  group_by(thisGCM, rcpStp, row, col, thisLat, thisLong) %>%
  summarise(avTemp = mean(avt))

# FIXME: Fix name issue with GCM: Sort out source later
unique(temperature$thisGCM)
unique(adapt_sow_eff$thisGCM)

```

## Total wheat + maize per pixel in ERA

```{r}

df_rot_yield <- df_worked %>%
  filter(thisScenario=="Baseline") %>% # normalise by baseline
  dplyr::select(row,col,thisGCM, thisCrop, thisSoil, thisCultivar, Adaptation, TotalBiomass) %>%
  group_by(row,col,thisGCM, thisCrop, thisSoil, thisCultivar, Adaptation) %>%
  summarise_each(funs(mean)) %>%
  tidyr::spread(thisCrop, TotalBiomass) %>%
  mutate(TotalBiomassRot = (maize+wheat)) %>%
  dplyr::select(-Adaptation)

summary(df_rot_yield)

```

## merge adapt efefctiveness with temp

```{r}

# merge temp
dftemp1 <- merge(adapt_sow_eff,temperature, by=c("row","col","thisGCM"))

# merge baseline yields per GCM
dftemp2 <- merge(dftemp1,df_rot_yield, by=c("row","col","thisCultivar", "thisSoil", "thisGCM"))

# Calculate relative adaptation effectiveness by baseline "rotation" yield

df_tot_bio_diff_temp <- dftemp2 %>%
  mutate(adaptEffect_rel = adaptEffect_a/(TotalBiomassRot/1000)*100)

summary(df_tot_bio_diff_temp)
```

## Graph

```{r, fig.height=8, fig.width=12}

df_tot_bio_diff_temp %>%
 # filter(thisGCM =="GFDL-CM3")  %>%
  filter(thisRCP=="RCP85") %>%
  ggplot(aes(x=avTemp,y=adaptEffect_rel, colour=thisSoil, shape=thisSoil)) +
  geom_point(shape=2, alpha=0.5) +
  geom_smooth() +
  facet_grid(thisGCM~thisCultivar+thisScenario) +
  ylab("Effectiveness of adaptation \n(% baseline rotation yield)")

```

## Find maximum yield of individual crops (ERA)

- Calculates a relative "both crops" yield for each grid cell 
- in relation to the maximum for the catchment ("catchment" yield gap)
- Values for each soil type

```{r}

# Potential yield for individual crops and total
df_era_pot_byCrop <- df_worked %>%
  filter(thisRCP == "ERA") %>%
  group_by(thisCrop) %>%
  dplyr::select(thisCrop, TotalBiomass) %>%
  summarise_each(funs(max)) %>%
  mutate(PotYieldERA = TotalBiomass/1000) %>%
  dplyr::select(-TotalBiomass)

maize_Y_max <- df_era_pot_byCrop %>% 
  filter(thisCrop == "maize") %>% 
  dplyr::select(PotYieldERA) %>% 
  as.numeric()

wheat_Y_max <- df_era_pot_byCrop %>% 
  filter(thisCrop == "wheat") %>% 
  dplyr::select(PotYieldERA) %>%
  as.numeric()

rot_Y_max <- totalBioRot %>%
  ungroup()%>%
  filter(thisGCM == "ERA") %>% 
  dplyr::select(TotalBiomass_Rot) %>%
  summarise(Ymax=max(TotalBiomass_Rot)) %>%
  as.numeric()

print(paste0("Maximum yield of total biomass (maize) in a single pixel is ",maize_Y_max," t/ha"))
print(paste0("Maximum yield of total biomass (maize) in a single pixel is ",wheat_Y_max," t/ha"))
print(paste0("Maximum yield of total biomass (maize + wheat) in a single pixel is ",rot_Y_max," t/ha"))

```

## Create a relative yield in relation to potential yield per pixel

- mean per pixel

```{r}

df_era_relY <- df_worked %>%
  filter(thisRCP == "ERA") %>%
  dplyr::select(row:thisGCM, year, thisCrop, Adaptation, TotalBiomass) %>%
  tidyr::spread(thisCrop, TotalBiomass) %>%
  mutate(totBio = (wheat+maize)) %>%
  dplyr::select(row,col, maize, wheat, totBio) %>%
  group_by(row, col) %>%
  summarise_each(funs(mean)) %>%
  mutate(rel_M= maize/1000/maize_Y_max, 
         rel_W= wheat/1000/wheat_Y_max, 
         rel_T= totBio/1000/rot_Y_max) %>% # relative yield to max catchment
  dplyr::select(row, col,rel_M:rel_T)

summary(df_era_relY)
```

Relative yield of maize is a good proxy for relative yield of total biomass

Check

```{r}
df_era_relY %>%
  ggplot(aes(x=rel_T,y=rel_M)) +
  geom_point() +
  geom_smooth(method='lm') +
  xlab("Relative yield per pixel for total biomass in rotation") +
  ylab("Relative yield per pixel for maize biomass")

```

## Merge relative yield with adapt effectiveness

- graph it
- Sowing date adaptation alwaysbenefit more the low WHC soil

```{r, fig.height=8, fig.width=12}

df_tot_bio_diff_temp_relY <- merge(df_tot_bio_diff_temp,df_era_relY, by=c("row","col"))
  
df_tot_bio_diff_temp_relY %>%
  ggplot(aes(x=1-rel_T,y=adaptEffect_rel, colour=thisScenario, shape=thisSoil, linetype=thisSoil)) +
  geom_point(size=2, alpha=0.5) +
  geom_smooth() +
  scale_shape_discrete(solid=F) +
  facet_grid(thisGCM~thisRCP+thisCultivar, scale = "free") +
  ylab("Effectiveness of sowing date adaptation \n(% baseline rotation yield)") +
  xlab("Yield gap in relation to maximum catchment baseline (fractional)")

#View(df_tot_bio_diff_temp_relY)
```

## same figure for paper

- only RCP8.5
- FIXME: Unfinished

```{r, fig.height=8, fig.width=8}
df_tot_bio_diff_temp_relY %>%
  filter(thisRCP == "RCP85") %>%
#  ggplot(aes(x=rel_T,y= adaptEffect_rel, colour=thisScenario, shape=thisSoil, linetype=thisSoil)) +
  ggplot(aes(x=Altitude_masl,y= adaptEffect_rel, colour=thisScenario, shape=thisCultivar, linetype=thisCultivar)) +
  geom_point(size=2, alpha=0.5) +
  geom_smooth() +
  scale_shape_discrete(solid=F) +
  facet_grid(thisGCM~thisSoil) +
  ylab("Effectiveness of sowing date adaptation \n(% baseline yield)") +
  xlab("Relative baseline yield (fractional)")
```

#-------------------------------
# Genotype effectiveness of adaptation
# ------------------------------

```{r}

df_tot_bio_diff_temp_relY %>%
  filter(thisRCP == "RCP85") %>%
  summary()

# calculate the difference in adaptation response between long and short

```


#-------------------
# Quality check
#------------------

- Are results an artifact of modelling set up?
- Check if the sowing date effect is happening because all sowing dates, when adapted, reached the earliest possible sowing date (day 246)
- Outcome: No, very rarely day 246 was used as sowing date ... and to a maximum of 36% of all years in a pixel

```{r}
checkDF <- df_worked %>%
  filter(thisCrop=="maize" & 
           thisScenario == "End-century"  & 
           Adaptation == "Adapted sow") %>%
  mutate(pix = paste0(thisLat,"_",thisLong)) %>%
 # dplyr::select(row:SowingDOY) %>%
  group_by(pix,thisGCM, thisScenario,thisCrop,Adaptation, Altitude_masl) %>% # summary of all years
  summarise(countMin=sum(SowingDOY<=250), countAll = sum(!is.na(SowingDOY))) %>%
  mutate(percHitLow=(countMin/countAll*100))
  
summary(checkDF)

```

# Plot % of years when "lower limit" of sowing date was selected 

- In the worst case, less than 3 pixels (from 45) had selected sowing dates <day 250, with this happening no more than 36% of 20 year runs
- Conclusion, decay of adaptation effectiveness is not an artifact of model set up

```{r, fig.height=8, fig.width=12, warning=FALSE}

checkDF %>%
  filter(percHitLow!=0) %>%
  ggplot(aes(x=percHitLow)) +
  geom_histogram() +
  facet_grid(thisGCM~.)
  
  
```

